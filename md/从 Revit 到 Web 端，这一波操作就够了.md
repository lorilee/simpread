> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.360doc.com](http://www.360doc.com/content/20/0818/02/21412_930868032.shtml)

> **作者：徐蕾**

基于 Autodesk Revit 制作的 BIM 模型数据，如何在 GIS 项目中使用。本文将以 RVT 模型数据为例，通过 SuperMap iDesktop 桌面软件、SuperMap iServer 服务管理平台以及 SuperMap iClient3D for WebGL 二次开发平台，梳理 BIM+GIS 项目建设的全流程，详细介绍 Revit 模型从接入到 Web 端应用的技术要点，同时汇总分享大家在此过程中常见的问题。

1.  将 Revit 模型转入 SuperMap；
    
2.  根据项目需要或数据特点深入处理模型数据；
    
3.  通过 SuperMap iServer 发布三维服务；
    
4.  通过 SuperMap iClient3D for WebGL 开发 WebGIS 项目。
    

1.  Autodesk Revit 软件；
    
2.  SuperMap iDesktop、SuperMap iServer 和 SuperMap iClient 3D for WebGL；
    
3.  超图 Revit 插件：通过百度网盘（链接：https://eyun.baidu.com/s/3dzbgVO，密码：8SsM）下载。
    

注意事项：  
a) 目前超图 Revit 插件支持的 Revit 版本为 Revit2016~2020；  
b) 插件经常更新，建议大家下载使用网盘上的最新版本；  
c) 网盘中提供了 Revit 插件配置的说明文档，请参考该文档进行配置。

第一步 将 Revit 模型转入 SuperMap
-------------------------

1.  如果使用的是低于 10i 版本的 iDesktop，请安装导出插件到 Revit，然后借助该插件导出模型到 SuperMap 数据源文件中。  
    具体操作是：启动 Revit 软件，打开 RVT 模型数据，在 “项目浏览器” 中选择三维视图模式，RVT 模型数据需要在该模式下导出数据。![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_1_20200818021631615)
    
2.  在 Revit 软件的 “附加模块” 中，点击 Revit 插件，如下图。![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_2_20200818021631646)  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_3_20200818021631740)
    
3.  设置导出参数后，点击 “确定” 按钮，将 Revit 的模型的几何信息和属性信息，一次性批量导出到 SuperMap 的数据源文件中。
    

提示：  
如果使用的是 10i 及以上版本的 iDesktop，可以直接使用 “导入 BIM 数据 - Revit” 功能，将模型导入到 SuperMap 数据源文件中，需要设置的参数与使用插件导出类似。  
这种方式不要求安装插件到 Revit，但计算机上要安装与 iDesktop 位数一致的 Revit 软件。  
![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_4_20200818021631927)  
**常见问题：**  
a）设置导出参数时需要注意什么？选择输入 “模型定位点” 还是“导入投影文件”？  
场景投影信息：通过插入点或者投影信息文件来确定 RVT 模型在超图三维场景中的位置。若已知测量点在球面 / 投影坐标系的坐标值，输入该坐标值作为模型定位点；若 Revit 建模是基于坐标系的值进行的，则选择 “导入投影文件”（*.xml）。  
导出网络数据集：若 RVT 模型中存在管线、风管、电缆架桥等数据，在 GIS 应用中需要使用三维网络分析功能，建议勾选 “导出网络数据集”，该参数会将数据导出为相应的三维点、线数据集。后续可以通过桌面软件基于该三维点、线构成三维网络数据集。  
新建数据源：插件会将 RVT 模型数据存储在 SuperMap 数据源文件中，因此该参数用于设置数据源存放路径。

b）如果原始 RVT 模型是基于地方坐标系制作的，具体操作方法如下：  
首先，Revit 软件中，利用插件导出模型数据，选择输入 “平面坐标”，并以测量点在地方坐标系中的值作为插入点。  
![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_5_202008180216325)  
其次，使用 SuperMap iDesktop 打开上一步导出的数据源，打开模型数据集的 “属性” 视窗，在 “坐标系” 选项卡中，重新设定其坐标系为地方坐标系。  
![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_6_20200818021632115)  
提示：如果 RVT 模型需要用于 WebGL 开发，可以使用 SuperMap iDesktop 的投影转换功能（开始菜单 - 投影转换 - 数据集投影转换），将地方坐标系转换成 China2000 或 WGS1984 坐标系。

c）如果 RVT 模型使用了过滤器添加颜色，导出时颜色缺失，可能是因为模型导出时未勾选 “着色颜色” 而使用了 “真实颜色”，建议使用“着色颜色” 导出并查看效果；此外，目前仅支持贴图和过滤器颜色，其他材质效果暂时导不出来。

第二步 据项目需要或数据特点深入处理模型数据
----------------------

1.  RVT 的模型是否需要单体化处理？  
    将 RVT 模型导出之后，不需要对其进行单体化操作，模型数据集中的构件对象与 Revit 软件中是一样的，构件已经是单体了。
    
2.  RVT 模型在 SuperMap 中是否可以编辑？  
    RVT 模型导出之后，如果需要手动修改几何信息（例如位置、贴图等）和属性信息，都可以直接在 SuperMap iDesktop 中进行操作，不需要重新导出。  
    操作方法：编辑模型的位置和贴图时，先选中模型，在右键菜单选择 “编辑模型”。其中，只有带 uv 坐标的贴图文件，才能用于对 RVT 模型进行贴图。  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_7_20200818021632193)  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_8_20200818021632224)  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_9_20200818021632286)
    
3.  制作和导出模型的时候随意设置的模型插入点坐标，如何校正模型的坐标？  
    模型导入到 SuperMap 数据源中，如果坐标不正确，可以通过配准的功能（开始菜单 - 新建三维配准）来纠正模型数据的坐标。在三维配准时可以使用二三维线面，栅格或者影像数据作为参考数据集。
    

![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_10_20200818021632411)  
![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_11_20200818021632630)

1.  RVT 模型与倾斜摄影模型数据、地形数据如何精确匹配？  
    如果 RVT 模型与倾斜摄影模型数据相互遮盖，一般是通过 “三维地理设计 - 截面与投影 - 提取边界” 获得 RVT 模型的范围面，再使用 “三维地理设计 - 倾斜摄影操作 - 镶嵌 / 挖洞” 功能，把倾斜摄影模型进行平整处理；如果 RVT 模型与地形数据相互遮盖，可以基于 RVT 模型的范围面，使用 “三维地理设计 - TIN 地形操作 - 镶嵌 / 挖洞” 功能修改地形表面，使之与模型精确匹配起来。  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_12_20200818021632771)  
    提示：  
    如果是高速路及隧道模型，存在地形完全覆盖路面和边沟的情况，需要与 TIN 地形进行精确匹配，首先准备隧道路段三维线数据，使用 “三维地理设计 - 放样” 功能生成隧道实体模型，再通过 “三维地理设计 - TIN 地形操作 - 布尔运算” 功能从 TIN 地形中挖出一条隧道。整个过程都是手动操作完成，如果会. NET 组件，可以自行开发批处理工具。  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_13_20200818021632896)
    
2.  RVT 模型构件多且精细，数据量大，加载速度慢，如何优化？  
    对 RVT 模型进行优化的主要方式包括实例化、BIM 轻量化处理和生成三维切片缓存等，下面列举 3 个最常用的功能进行说明。  
    a）实例化  
    添加 RVT 模型到球面三维场景，使用 “实例化处理” 工具（三维数据 - 模型工具 - 实例化处理）能够实现相同的几何模型只保存绘制一个，降低显卡和内存的压力，适用于重复模型较多的情况。  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_14_20200818021632974)  
    b）三角网简化  
    很多 RVT 模型存在大量冗余的三角面，通过三角网简化（三维地理设计 - 模型编辑 - 三角网简化）功能，可以实现对这些模型进行批量简化，降低内存的占用。  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_15_2020081802163336)  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_16_20200818021633115)  
    c）操作子对象  
    添加数据后，找到 “三维地理设计 - 模型编辑 - 操作子对象” 功能，可以对单个的模型进行简化、或者直接删除在 GIS 中无用的子对象，如建筑物里面的门把手、锁芯等。
    
3.  模型数据如何生成三维切片缓存？  
    将模型数据生成缓存可分为两种方式，一种是多个模型数据集批量生成到一个缓存图层中，另一种是每个数据集分别生成一个缓存图层。对于 RVT 模型来说，一般采用批量生成缓存的方式，它的主要优势在于能够减少图层数量，加强系统调度。  
    操作方法：打开数据源文件，使用 “批量生成缓存” 功能（三维数据 - 生成缓存 - 批量生成缓存 - 模型），添加多个模型数据集，批量生成 S3M 缓存，以提升模型浏览性能。  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_17_20200818021633177)  
    a）设置缓存参数  
    设置 “缓存用途” 参数，主要包括普通 PC 设备和 iOS 系列设备、Android 系列设备和不压缩，对于不同用途的缓存，应用程序将采用不同的纹理压缩方式，以减少纹理图像所使用的显存数量。  
    若需要将模型添加到平面场景中，可以将 “场景类型” 改为“平面”。  
    设置 “LOD 层数” 以及每层数据的简化率，当三维场景拉近看的时候，模型呈现最精细的一层，当浏览整个场景的时候，模型只需要以较粗糙的方式显示即可，这样最大程度的优化资源的占用，提高整个三维场景的性能。
    

![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_18_20200818021633302)  
b）缓存加载到场景中，保存场景和工作空间  
新建一个球面场景，通过 “添加三维切片缓存” 功能，将生成的缓存添加到场景中，保存场景命名为“BIMScene”，并保存工作空间命名为“BIM”。  
![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_19_20200818021633396)

第三步 通过 SuperMap iServer 发布三维服务
------------------------------

1.  启动 iServer 服务，打开 iServer 服务管理页面，使用 “快速发布一个或一组服务” 功能，选择发布 “工作空间”，远程浏览添加“BIM.smwu” 工作空间文件。  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_20_20200818021633568)![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_21_20200818021633708)  
    提示：发布服务时，也可以选择 “数据来源” 为“三维切片缓存”，直接发布三维切片缓存，然后在 Web 端访问时使用 scene.addS3MTilesLayerByScp 方法添加三维切片缓存图层到三维场景中。
    

![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_22_20200818021633771)

1.  选择发布的服务类型为 “REST - 三维服务”。  
    提示：iServer 会对选择发布的工作空间进行分析判断，如果 “REST - 三维服务” 的复选框为灰色，请检查工作空间中是否没有成功保存三维场景；如果需要在 Web 客户端实现 SQL 查询，还需要勾选“REST - 数据服务”。  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_23_20200818021633849)
    
2.  完成服务配置后，将获得访问该服务的超链接：  
    http://localhost:8090/iserver/services/3D-BIM/rest  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_24_20200818021633958)  
    **常见问题：**  
    服务发布完成后，如果对发布的工作空间进行了修改，例如使用 SuperMap iDesktop 在三维场景中增加了一个图层，或者修改了图层风格，不需要重新发布服务。SuperMap iServer 会对发布的工作空间进行实时的检查，一旦发现有变化，会自动更新服务。
    

第四步 通过 SuperMap iClient3D for WebGL 开发 WebGIS 项目
------------------------------------------------

SurerMap iServer 三维服务支持客户端进行一系列的操作，例如加载图层、自定义 Action 等。本文以打开加载了 S3M 缓存图层的三维场景为例，演示 RVT 模型在 Web 客户端上的访问与浏览。

1.  获取三维服务地址  
    在三维服务根目录下，点击 “Realspace” 进入 3D 资源，即三维服务根节点地址：  
    （http://localhost:8090/iserver/services/3D-BIM/rest/realspace），用于在 Web 端访问发布的三维场景。  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_25_202008180216345)
    
2.  创建 WebGIS 工程  
    本文直接使用 SuperMap iServer 自带的 Tomcat 进行工程发布。在 SuperMap iServer 安装目录下的 webapps 文件夹中，创建工程目录 “HelloWorld”，将 SuperMap iClient 3D for WebGL 中的 Build 文件夹复制到工程目录中。其中最重要的是 Build\Cesium 文件夹，它包含了 Cesium.js 及所有需要的依赖文件。  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_26_20200818021634161)
    
3.  实现场景加载  
    在工程目录中创建 HTML 文件—HelloWorld.html，添加对 Cesium.js 文件的引用，添加对 widgets.css 样式文件的引用，然后在窗体加载响应函数中，实例化 Viewer，并通过 viewer 对象获取到场景对象 scene，再获取到在线三维场景服务地址，最后通过 scene 对象提供的 open 方法，打开在线三维场景。具体代码如下：  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_27_20200818021634224)  
    **常见问题：**  
    a）三维场景中，除了加载 S3M 缓存, 还可以同时加载在线地图叠加显示，如果看不到在线地图，检查模型的坐标系或坐标值是否正确。  
    b）如果把多种数据都放在了同一个场景中，那么在 WebGL 开发中直接用 scene.open 方法打开就可以了；如果数据是在不同的场景或者不同的工作空间中，那么可以使用 scene.addS3MTilesLayerByScp 方法依次添加图层到同一个场景中。  
    c）在 Web 端浏览时，如果需要控制各图层的显隐状态，可以通过 layer.setOnlyObjsVisible(ids,true) 来实现，具体代码可以参考范例。  
    [http://support.supermap.com.cn:8090/webgl/examples/editor.html#S3MTiles](http://support.supermap.com.cn:8090/webgl/examples/editor.html#S3MTiles)
    
4.  通过浏览器浏览三维场景  
    使用 Chrome 浏览器，访问 http://localhost:8090/HelloWorld/HelloWorld.html，即可浏览三维场景中的 RVT 模型数据。  
    ![](http://image109.360doc.com/DownloadImg/2020/08/1802/199577604_28_20200818021634333)